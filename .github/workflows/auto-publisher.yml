name: ðŸš€ Auto Publisher - YouTube Upload Pipeline

on:
  # ExecuÃ§Ã£o manual
  workflow_dispatch:
    inputs:
      sync_drive:
        description: 'Sincronizar novos vÃ­deos do Drive?'
        required: true
        default: 'true'
        type: boolean
      max_videos:
        description: 'MÃ¡ximo de vÃ­deos para processar'
        required: true
        default: '1'
        type: string
      dry_run:
        description: 'Modo preview (nÃ£o fazer upload real)?'
        required: false
        default: false
        type: boolean
  
  # ExecuÃ§Ã£o automÃ¡tica (opcional)
  schedule:
    - cron: '0 10 * * *'  # Todo dia Ã s 10h UTC (7h BrasÃ­lia)

env:
  NODE_VERSION: '18'

jobs:
  auto-publisher:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”§ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        echo "ðŸ“¦ Instalando dependÃªncias..."
        npm install
        echo "âœ… DependÃªncias instaladas"
        
    - name: ðŸ” Setup Environment Variables
      run: |
        echo "ðŸ” Configurando variÃ¡veis de ambiente..."
        echo "NOTION_TOKEN=${{ secrets.NOTION_TOKEN }}" >> .env
        echo "NOTION_DATABASE_ID=${{ secrets.NOTION_DATABASE_ID }}" >> .env
        echo "GOOGLE_DRIVE_FOLDER_ID=${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}" >> .env
        echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
        echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env
        echo "GOOGLE_REFRESH_TOKEN=${{ secrets.GOOGLE_REFRESH_TOKEN }}" >> .env
        echo "YOUTUBE_CLIENT_ID=${{ secrets.YOUTUBE_CLIENT_ID }}" >> .env
        echo "YOUTUBE_CLIENT_SECRET=${{ secrets.YOUTUBE_CLIENT_SECRET }}" >> .env
        echo "YOUTUBE_REFRESH_TOKEN=${{ secrets.YOUTUBE_REFRESH_TOKEN }}" >> .env
        echo "âœ… VariÃ¡veis configuradas"
        
    - name: ðŸ”„ Sync Google Drive (Opcional)
      if: ${{ github.event.inputs.sync_drive == 'true' || github.event_name == 'schedule' }}
      run: |
        echo "ðŸ”„ Sincronizando vÃ­deos do Google Drive..."
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          node 5syncgdrive.js --preview --limit=${{ github.event.inputs.max_videos || '1' }}
        else
          node 5syncgdrive.js --limit=${{ github.event.inputs.max_videos || '1' }}
        fi
        echo "âœ… SincronizaÃ§Ã£o concluÃ­da"
        
    - name: ðŸ“‹ Fetch Pending Videos
      id: fetch_videos
      run: |
        echo "ðŸ“‹ Buscando vÃ­deos pendentes..."
        node 1fetchvideos.js | tee fetch_output.txt
        
        # Extrair page_id do output
        PAGE_ID=$(grep -oP 'ðŸ“„ ID da pÃ¡gina: \K[a-f0-9-]+' fetch_output.txt | head -1)
        
        if [ -z "$PAGE_ID" ]; then
          echo "ðŸ“­ Nenhum vÃ­deo pendente encontrado"
          echo "has_video=false" >> $GITHUB_OUTPUT
        else
          echo "ðŸŽ¯ VÃ­deo encontrado: $PAGE_ID"
          echo "has_video=true" >> $GITHUB_OUTPUT
          echo "page_id=$PAGE_ID" >> $GITHUB_OUTPUT
        fi
        
    - name: ðŸ“¥ Download Video
      if: steps.fetch_videos.outputs.has_video == 'true'
      run: |
        echo "ðŸ“¥ Fazendo download do vÃ­deo..."
        PAGE_ID="${{ steps.fetch_videos.outputs.page_id }}"
        node 2downloadvideo.js "$PAGE_ID"
        echo "âœ… Download concluÃ­do"
        
    - name: ðŸ“¤ Upload to YouTube
      if: steps.fetch_videos.outputs.has_video == 'true' && github.event.inputs.dry_run != 'true'
      run: |
        echo "ðŸ“¤ Enviando para o YouTube..."
        PAGE_ID="${{ steps.fetch_videos.outputs.page_id }}"
        node 3uploadyoutube.js "$PAGE_ID"
        echo "âœ… Upload concluÃ­do"
        
    - name: ðŸŽ­ Dry Run Preview
      if: steps.fetch_videos.outputs.has_video == 'true' && github.event.inputs.dry_run == 'true'
      run: |
        echo "ðŸŽ­ MODO PREVIEW - Upload nÃ£o serÃ¡ realizado"
        echo "ðŸ“„ Page ID: ${{ steps.fetch_videos.outputs.page_id }}"
        echo "ðŸŽ¬ VÃ­deo seria enviado para o YouTube"
        
    - name: ðŸ§¹ Cleanup Temporary Files
      if: always()
      run: |
        echo "ðŸ§¹ Limpando arquivos temporÃ¡rios..."
        rm -rf temp/
        rm -f fetch_output.txt
        rm -f .env
        echo "âœ… Limpeza concluÃ­da"
        
    - name: ðŸ“Š Summary
      if: always()
      run: |
        echo "ðŸ“Š RESUMO DA EXECUÃ‡ÃƒO"
        echo "========================"
        if [ "${{ steps.fetch_videos.outputs.has_video }}" = "true" ]; then
          echo "âœ… VÃ­deo processado: ${{ steps.fetch_videos.outputs.page_id }}"
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "ðŸŽ­ Modo preview - Nenhum upload real foi feito"
          else
            echo "ðŸ“¤ Upload realizado com sucesso"
          fi
        else
          echo "ðŸ“­ Nenhum vÃ­deo pendente encontrado"
        fi
        echo "========================"
